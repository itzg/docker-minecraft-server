#!/bin/bash

# shellcheck source=start-utils
. "$(dirname "$0")/start-utils"
isDebugging && set -x

: "${MAGMA_VERSION:=}"

resolveVersion

# Neo Magma currently supports just 1.21.x
if [[ ! $VERSION =~ ^1\.21(\.[0-9]+)?$ ]]; then
logError "Magma does not support $VERSION (expected 1.21.x)"
exit 1
fi

if ! downloadUrl=$(get --json-path '$.link' "https://magmafoundation.org/api/versions/${MAGMA_VERSION}/download"); then
  logError "Failed to locate latest Magma download for ${VERSION}. Is that version supported?"
  exit 1
fi

if [[ $downloadUrl == null ]]; then
  logError "Magma does not seem to be available for $VERSION"
  exit 1
fi

if ! SERVER=$(get --output-filename --skip-up-to-date --output /data "$downloadUrl"); then
  logError "Failed to download Magma server jar from $downloadUrl"
  exit 1
fi

export SERVER
export FAMILY=HYBRID
export HYBRIDTYPE=forge

exec "$(dirname "$0")/start-spiget" "$@"
